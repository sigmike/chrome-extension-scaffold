#!/usr/bin/env watchr

require 'rubygems'
require "bundler/setup"
require 'haml'
<% if coffee? -%>
require 'erubis'
require 'coffee-script'
<% end -%>

def log_built(src, dst)
  puts [src, dst].join(" => ")
end

<% if coffee? -%>
watch( '(.+)\.coffee$' ) do |md|
  src = md[0]
  dst = md[1]
  
  js = File.read(src)
  eruby = Erubis::Eruby.new(js)
  js = eruby.result(binding())
  js = CoffeeScript.compile(js)
  File.open(dst, "w") { |f| f.write js }
  log_built(src, dst)
end
<% end -%>

<% if haml? -%>
watch( '(.+)\.haml$' ) do |md|
  src = md[0]
  dst = md[1]
  
  template = File.read(src)
  haml_engine = Haml::Engine.new(template, :filename => src)
  output = haml_engine.render(binding())
  File.open(dst, "w") { |f| f.write output }
  log_built(src, dst)
end
<% end -%>
